// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Plan {
  plan_id       BigInt   @id @default(autoincrement())
  plan_name     String   @unique @db.VarChar(100)
  monthly_price Decimal  @db.Decimal(10, 2)
  billing_cycle String   @db.VarChar(10)
  currency      String   @default("KRW") @db.VarChar(3)
  is_active     Boolean  @default(true)
  subscriptions Subscription[]
}

model Customer {
  customer_id BigInt   @id @default(autoincrement())
  name        String   @db.VarChar(100)
  email       String   @unique @db.VarChar(255)
  status      String   @db.VarChar(20)
  created_at  DateTime @default(now()) @db.Timestamp
  subscriptions Subscription[]

  @@index([status])
}

model Subscription {
  subscription_id    BigInt   @id @default(autoincrement())
  customer_id        BigInt
  plan_id            BigInt
  start_date         DateTime @db.Date
  end_date           DateTime? @db.Date
  next_billing_date  DateTime @db.Date
  status             String   @db.VarChar(20)
  payment_method_token String? @db.VarChar(255)
  payment_type       String   @default("RECURRING") @db.VarChar(20)

  customer           Customer @relation(fields: [customer_id], references: [customer_id])
  plan               Plan     @relation(fields: [plan_id], references: [plan_id])
  invoices           Invoice[]

  @@index([customer_id])
  @@index([plan_id])
  @@index([status])
}

model Invoice {
  invoice_id      BigInt    @id @default(autoincrement())
  subscription_id BigInt
  amount_paid     Decimal   @db.Decimal(10, 2)
  billing_date    DateTime  @default(now()) @db.Timestamp
  payment_status  String    @db.VarChar(20) // PAID, FAILED, PENDING
  
  subscription    Subscription @relation(fields: [subscription_id], references: [subscription_id])

  @@index([subscription_id])
  @@index([payment_status])
  @@index([billing_date])
}
